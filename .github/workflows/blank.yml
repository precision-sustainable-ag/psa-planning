name: Add Issues to GitHub Project and Update Fields

on:
  issues:
    types: [opened]

jobs:
  add_to_project_and_update_fields:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate with GitHub App
        id: authenticate
        run: |
          echo "${{ secrets.GITHUB_APP_PRIVATE_KEY }}" > /tmp/private_key.pem
          jwt=$(jwt-cli encode --header alg=RS256 --header typ=JWT --claim exp=$(date -d "+10 minutes" +%s) --claim iss=${{ secrets.GITHUB_APP_ID }} --key /tmp/private_key.pem)
          installation_token=$(curl -s -X POST -H "Authorization: Bearer $jwt" -H "Accept: application/vnd.github.v3+json" https://api.github.com/app/installations/${{ secrets.GITHUB_APP_INSTALLATION_ID }}/access_tokens | jq -r .token)
          echo "GITHUB_APP_TOKEN=$installation_token" >> $GITHUB_ENV

      - name: Add issue to GitHub Project and Update Fields
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const projectId = 'PVT_kwDOAwh9p84AEOSL'; // Replace with your project ID
            const issueId = context.payload.issue.node_id;
            
            // Find labels
            const labels = context.payload.issue.labels.map(label => label.name);
            const teamLabel = labels.find(label => label.startsWith('team:'));
            const projectLabel = labels.find(label => label.startsWith('project:'));
            const teamValue = teamLabel ? teamLabel.split(':')[1].trim() : null;
            const projectValue = projectLabel ? projectLabel.split(':')[1].trim() : null;
            // Add the issue to the GitHub project
            const addIssueToProjectMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item {
                    id
                  }
                }
              }
            `;
            const result = await github.graphql(addIssueToProjectMutation, {
              projectId: projectId,
              contentId: issueId
            });
            console.log('Result:', result);
            const projectItemId = result.addProjectV2ItemById.item.id;
            // Update custom fields
            if (teamValue || projectValue) {
              const updateFieldsMutation = `
                mutation($projectItemId: ID!, $teamValue: String, $projectValue: String) {
                  updateProjectV2ItemField(input: {
                    projectId: $projectId,
                    itemId: $projectItemId,
                    fieldUpdates: [
                      {fieldName: "Team", value: $teamValue},
                      {fieldName: "Project", value: $projectValue}
                    ]
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;
              const updateResult = await github.graphql(updateFieldsMutation, {
                projectItemId: projectItemId,
                teamValue: teamValue,
                projectValue: projectValue
              });
              console.log('Update Result:', updateResult);
            }
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_APP_TOKEN }}
